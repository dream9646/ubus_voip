#!/bin/sh
# the script is called when gpon mac stuck is detected by omci onu_watchdog
# it is used to log chip register status for future debugging

PATH=/bin:/sbin:/usr/bin:/usr/sbin:/etc/init.d:/etc/bin; export PATH
LOGFILE="/etc/omci/onu_watchdog.log"

dma_cmd="
reg set 0x1b0 0x700

#reqsm
reg set 0x124 0x1000
reg get 0x64
reg set 0x124 0x1001
reg get 0x64
reg set 0x124 0x1002
reg get 0x64
reg set 0x124 0x1003
reg get 0x64
reg set 0x124 0x1004
reg get 0x64
reg set 0x124 0x1005
reg get 0x64
reg set 0x124 0x1006
reg get 0x64
reg set 0x124 0x1007
reg get 0x64
reg set 0x124 0x1008
reg get 0x64

#dmasm
reg set 0x124 0x1010
reg get 0x64
reg set 0x124 0x1011
reg get 0x64
reg set 0x124 0x1012
reg get 0x64
reg set 0x124 0x1013
reg get 0x64
reg set 0x124 0x1014
reg get 0x64
reg set 0x124 0x1015
reg get 0x64
reg set 0x124 0x1016
reg get 0x64
reg set 0x124 0x1017
reg get 0x64
reg set 0x124 0x1018
reg get 0x64

#data
reg set 0x124 0x1020
reg get 0x64
reg set 0x124 0x1021
reg get 0x64
reg set 0x124 0x1022
reg get 0x64
reg set 0x124 0x1023
reg get 0x64
reg set 0x124 0x1024
reg get 0x64
reg set 0x124 0x1025
reg get 0x64
reg set 0x124 0x1026
reg get 0x64
reg set 0x124 0x1027
reg get 0x64
reg set 0x124 0x1028
reg get 0x64
reg set 0x124 0x1029
reg get 0x64
reg set 0x124 0x102a
reg get 0x64
reg set 0x124 0x102b
reg get 0x64
reg set 0x124 0x102c
reg get 0x64
reg set 0x124 0x102d
reg get 0x64
reg set 0x124 0x102e
reg get 0x64
reg set 0x124 0x102f
reg get 0x64

#txpla
reg set 0x124 0x1080
reg get 0x64
reg set 0x124 0x1081
reg get 0x64
reg set 0x124 0x1082
reg get 0x64
reg set 0x124 0x1083
reg get 0x64
reg set 0x124 0x1084
reg get 0x64
reg set 0x124 0x1085
reg get 0x64

#txdma
reg set 0x124 0x1040
reg get 0x64
reg set 0x124 0x1041
reg get 0x64
reg set 0x124 0x1042
reg get 0x64
reg set 0x124 0x1043
reg get 0x64
reg set 0x124 0x1044
reg get 0x64
reg set 0x124 0x1045
reg get 0x64
reg set 0x124 0x1046
reg get 0x64
reg set 0x124 0x1047
reg get 0x64
reg set 0x124 0x1048
reg get 0x64
"

date > $LOGFILE
echo "
port get status port all 
gpon
gpon cnt
flowctrl dump used-page pon
# reg dump1 
$dma_cmd
# reg dump2
$dma_cmd
# reg dump3
$dma_cmd
# reg dump4
$dma_cmd
# reg dump5
$dma_cmd
" > /tmp/onu_watchdog.cmd

omci -f /tmp/onu_watchdog.cmd 2>&1 >> $LOGFILE
sync; sync
